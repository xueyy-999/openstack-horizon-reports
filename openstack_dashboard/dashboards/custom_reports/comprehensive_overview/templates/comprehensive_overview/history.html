{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block page_header %}
  {% include "horizon/common/_domain_page_header.html" with title=page_title %}
{% endblock page_header %}

{% block main %}
{% if has_history %}
<div class="container-fluid">
  <!-- 统计概览 -->
  <div class="row">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">{% trans "统计概览" %}</h3>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-md-3 text-center">
              <h2>{{ record_count }}</h2>
              <p>{% trans "记录条数" %}</p>
            </div>
            <div class="col-md-3 text-center">
              <h2>{{ avg_usage.compute.instances|floatformat:1 }}</h2>
              <p>{% trans "平均实例数" %}</p>
            </div>
            <div class="col-md-3 text-center">
              <h2>{{ avg_usage.compute.cores|floatformat:1 }}</h2>
              <p>{% trans "平均vCPU" %}</p>
            </div>
            <div class="col-md-3 text-center">
              <h2>{{ avg_usage.compute.ram|floatformat:0 }}</h2>
              <p>{% trans "平均内存 (MB)" %}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 计算资源趋势 -->
  <div class="row">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">{% trans "计算资源历史趋势" %}</h3>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-md-4">
              <h4>{% trans "实例数量趋势" %}</h4>
              <canvas id="histInstancesChart" width="400" height="250"></canvas>
            </div>
            <div class="col-md-4">
              <h4>{% trans "vCPU 使用趋势" %}</h4>
              <canvas id="histCoresChart" width="400" height="250"></canvas>
            </div>
            <div class="col-md-4">
              <h4>{% trans "内存使用趋势" %}</h4>
              <canvas id="histRamChart" width="400" height="250"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 存储资源趋势 -->
  <div class="row">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">{% trans "存储资源历史趋势" %}</h3>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-md-6">
              <h4>{% trans "卷数量趋势" %}</h4>
              <canvas id="histVolumesChart" width="400" height="250"></canvas>
            </div>
            <div class="col-md-6">
              <h4>{% trans "存储容量趋势 (GB)" %}</h4>
              <canvas id="histGigabytesChart" width="400" height="250"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 网络资源趋势 -->
  <div class="row">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">{% trans "网络资源历史趋势" %}</h3>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-md-6">
              <h4>{% trans "浮动 IP 使用趋势" %}</h4>
              <canvas id="histFloatingipsChart" width="400" height="250"></canvas>
            </div>
            <div class="col-md-6">
              <h4>{% trans "路由器数量趋势" %}</h4>
              <canvas id="histRoutersChart" width="400" height="250"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 数据表格 -->
  <div class="row">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">{% trans "详细数据表格" %}</h3>
        </div>
        <div class="panel-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>{% trans "时间" %}</th>
                  <th>{% trans "实例" %}</th>
                  <th>{% trans "vCPU" %}</th>
                  <th>{% trans "内存(MB)" %}</th>
                  <th>{% trans "卷" %}</th>
                  <th>{% trans "存储(GB)" %}</th>
                  <th>{% trans "浮动IP" %}</th>
                  <th>{% trans "路由器" %}</th>
                </tr>
              </thead>
              <tbody>
                {% for h in detailed_history.dates %}
                <tr>
                  <td>{{ h }}</td>
                  <td>{{ detailed_history.compute.instances|get_index:forloop.counter0 }}</td>
                  <td>{{ detailed_history.compute.cores|get_index:forloop.counter0 }}</td>
                  <td>{{ detailed_history.compute.ram|get_index:forloop.counter0 }}</td>
                  <td>{{ detailed_history.storage.volumes|get_index:forloop.counter0 }}</td>
                  <td>{{ detailed_history.storage.gigabytes|get_index:forloop.counter0 }}</td>
                  <td>{{ detailed_history.network.floatingips|get_index:forloop.counter0 }}</td>
                  <td>{{ detailed_history.network.routers|get_index:forloop.counter0 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12 text-center">
      <a href="{% url 'horizon:custom_reports:comprehensive_overview:index' %}" class="btn btn-default">
        <i class="fa fa-arrow-left"></i> {% trans "返回综合概览" %}
      </a>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{{ detailed_history|json_script:"detailed-history-data" }}
{{ avg_usage|json_script:"avg-usage-data" }}
<script>
// 获取详细历史数据
var detailedHistory = JSON.parse(document.getElementById('detailed-history-data').textContent);
var avgUsage = JSON.parse(document.getElementById('avg-usage-data').textContent);

// 图表配置
const chartOptions = {
  responsive: true,
  scales: {
    y: {
      beginAtZero: true
    }
  }
};

// 计算资源 - 实例
new Chart(document.getElementById('histInstancesChart'), {
  type: 'line',
  data: {
    labels: detailedHistory.dates,
    datasets: [{
      label: '{% trans "实例数量" %}',
      data: detailedHistory.compute.instances,
      borderColor: 'rgb(75, 192, 192)',
      backgroundColor: 'rgba(75, 192, 192, 0.2)',
      tension: 0.1
    }, {
      label: '{% trans "配额上限" %}',
      data: detailedHistory.compute.instances_limit,
      borderColor: 'rgb(255, 99, 132)',
      borderDash: [5, 5],
      backgroundColor: 'rgba(255, 99, 132, 0.1)',
      tension: 0.1
    }]
  },
  options: chartOptions
});

// 计算资源 - vCPU
new Chart(document.getElementById('histCoresChart'), {
  type: 'line',
  data: {
    labels: detailedHistory.dates,
    datasets: [{
      label: '{% trans "vCPU 数量" %}',
      data: detailedHistory.compute.cores,
      borderColor: 'rgb(54, 162, 235)',
      backgroundColor: 'rgba(54, 162, 235, 0.2)',
      tension: 0.1
    }, {
      label: '{% trans "配额上限" %}',
      data: detailedHistory.compute.cores_limit,
      borderColor: 'rgb(255, 99, 132)',
      borderDash: [5, 5],
      backgroundColor: 'rgba(255, 99, 132, 0.1)',
      tension: 0.1
    }]
  },
  options: chartOptions
});

// 计算资源 - 内存
new Chart(document.getElementById('histRamChart'), {
  type: 'line',
  data: {
    labels: detailedHistory.dates,
    datasets: [{
      label: '{% trans "内存使用 (MB)" %}',
      data: detailedHistory.compute.ram,
      borderColor: 'rgb(255, 99, 132)',
      backgroundColor: 'rgba(255, 99, 132, 0.2)',
      tension: 0.1
    }, {
      label: '{% trans "配额上限" %}',
      data: detailedHistory.compute.ram_limit,
      borderColor: 'rgb(255, 99, 132)',
      borderDash: [5, 5],
      backgroundColor: 'rgba(255, 99, 132, 0.1)',
      tension: 0.1
    }]
  },
  options: chartOptions
});

// 存储资源 - 卷
new Chart(document.getElementById('histVolumesChart'), {
  type: 'line',
  data: {
    labels: detailedHistory.dates,
    datasets: [{
      label: '{% trans "卷数量" %}',
      data: detailedHistory.storage.volumes,
      borderColor: 'rgb(75, 192, 75)',
      backgroundColor: 'rgba(75, 192, 75, 0.2)',
      tension: 0.1
    }]
  },
  options: chartOptions
});

// 存储资源 - 容量
new Chart(document.getElementById('histGigabytesChart'), {
  type: 'line',
  data: {
    labels: detailedHistory.dates,
    datasets: [{
      label: '{% trans "存储容量 (GB)" %}',
      data: detailedHistory.storage.gigabytes,
      borderColor: 'rgb(153, 102, 255)',
      backgroundColor: 'rgba(153, 102, 255, 0.2)',
      tension: 0.1
    }]
  },
  options: chartOptions
});

// 网络资源 - 浮动IP
new Chart(document.getElementById('histFloatingipsChart'), {
  type: 'line',
  data: {
    labels: detailedHistory.dates,
    datasets: [{
      label: '{% trans "浮动IP数量" %}',
      data: detailedHistory.network.floatingips,
      borderColor: 'rgb(255, 159, 64)',
      backgroundColor: 'rgba(255, 159, 64, 0.2)',
      tension: 0.1
    }]
  },
  options: chartOptions
});

// 网络资源 - 路由器
new Chart(document.getElementById('histRoutersChart'), {
  type: 'line',
  data: {
    labels: detailedHistory.dates,
    datasets: [{
      label: '{% trans "路由器数量" %}',
      data: detailedHistory.network.routers,
      borderColor: 'rgb(255, 99, 255)',
      backgroundColor: 'rgba(255, 99, 255, 0.2)',
      tension: 0.1
    }]
  },
  options: chartOptions
});
</script>

{% else %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <div class="alert alert-info">
        <i class="fa fa-info-circle"></i>
        {% trans "暂无历史数据记录。" %}
        <br>
        {% trans "当您访问" %}
        <a href="{% url 'horizon:custom_reports:comprehensive_overview:index' %}">
          {% trans "综合资源概览" %}
        </a>
        {% trans "页面时，系统会自动收集资源使用快照。" %}
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12 text-center">
      <a href="{% url 'horizon:custom_reports:comprehensive_overview:index' %}" class="btn btn-primary">
        <i class="fa fa-arrow-left"></i> {% trans "返回综合概览" %}
      </a>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
